name: SonarCloud Multi-Repo Analysis

on:
  workflow_dispatch:  # Manually trigger the workflow
    inputs:
      repo:
        description: Which repository should be analysed?
        required: true
        type: choice
        default: '(all)'
        options:
          - '(all)'
          - cortezaproject/corteza
          - zegkljan/scorer
  schedule:  # On a schedule
    - cron: '0 16 * * 4'

jobs:
  sonarcloud-analysis:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config:
          - githubRepo: cortezaproject/corteza
            sonarProjectKey: security-check-box_corteza
            enabled: true
          - githubRepo: zegkljan/scorer
            sonarProjectKey: security-check-box_scorer
            enabled: true
#          - githubRepo: 'org1/repo1' # GitHub organization/repozitory name
#            sonarProjectKey: 's_pk1' # SonarCloud project key
#            enabled: true            # Whether the scheduled analysis of this repo is enabled
    steps:
      - name: Checkout ${{ matrix.config.githubRepo }}
        uses: actions/checkout@v4
        if: (github.event_name == 'schedule' && matrix.config.enabled) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.repo == '(all)' || github.event.inputs.repo == matrix.config.githubRepo ))
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
          repository: '${{ matrix.config.githubRepo }}'
          path: '${{ matrix.config.githubRepo }}'  # Checkout each repo in a unique path

      - name: Run SonarCloud Analysis @ ${{ matrix.config.githubRepo }}
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        if: (github.event_name == 'schedule' && matrix.config.enabled) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.repo == '(all)' || github.event.inputs.repo == matrix.config.githubRepo ))
        with:
          projectBaseDir: '${{ matrix.config.githubRepo }}'
          args: >
            -Dsonar.organization=security-check-box
            -Dsonar.projectKey=${{ matrix.config.sonarProjectKey }}
            -Dsonar.c.file.suffixes=-
            -Dsonar.cpp.file.suffixes=-
            -Dsonar.objc.file.suffixes=-

